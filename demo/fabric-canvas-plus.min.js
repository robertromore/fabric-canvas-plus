var transparentBackgroundData=new Image;transparentBackgroundData.src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+CjxyZWN0IHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbD0iI2ZmZiI+PC9yZWN0Pgo8cmVjdCB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIGZpbGw9IiNGN0Y3RjciPjwvcmVjdD4KPHJlY3QgeD0iMTAiIHk9IjEwIiB3aWR0aD0iMTAiIGhlaWdodD0iMTAiIGZpbGw9IiNGN0Y3RjciPjwvcmVjdD4KPC9zdmc+";var transparentBackgroundDataPattern=null,zeroPoint=function(){return new fabric.Point(0,0)},onePoint=function(){return new fabric.Point(1,1)},propExists=function(t,i){return void 0!==t[i]},isset=function(t,i){return propExists(t,i)&&!1!==t[i]&&null!==t[i]};fabric.BaseBrush.prototype._isOffCanvas=function(t){return t.x<0||t.y<0||t.x>this.canvas.subcanvas.width||t.y>this.canvas.subcanvas.height},fabric.BetterPencilBrush=fabric.util.createClass(fabric.PencilBrush,{initialize:function(t){this.canvas=t,this._lines={0:[]},this._lineIndex=0,this._cursorOnCanvas=!1},onMouseDown:function(t){console.log(t),this._cursorOnCanvas=!this._isOffCanvas(t),this._cursorOnCanvas&&this._prepareForDrawing(t)&&this._captureDrawingPath(t)&&this._render()},onMouseMove:function(t){var i=this._cursorOnCanvas;if(this._cursorOnCanvas=!this._isOffCanvas(t),this._cursorOnCanvas&&!i)0<this._lines[this._lineIndex].length&&(this._lines[++this._lineIndex]=new Array,this._prepareForDrawing(t)&&this._captureDrawingPath(t)),this.oldEnd=t;else if(!this._cursorOnCanvas)return;if(this._captureDrawingPath(t)){var e=this.canvas.contextTop,s=this._lines[this._lineIndex],r=s.length;if(r<=1)return;this._saveAndTransform(e),this.oldEnd&&(e.beginPath(),e.moveTo(this.oldEnd.x,this.oldEnd.y)),this.oldEnd=this._drawSegment(e,s[r-2],s[r-1]),e.stroke(),e.restore()}},onMouseUp:function(){this.oldEnd=void 0,0<this._lines[this._lineIndex].length&&this._finalizeAndAddPath()},_prepareForDrawing:function(t){var i=new fabric.Point(t.x,t.y);return!!this._addPoint(i)&&(this.canvas.contextTop.moveTo(i.x,i.y),!0)},_addPoint:function(t){if(this._isOffCanvas(t))return!1;var i=this._lines[this._lineIndex];return!(1<i.length&&t.eq(i[i.length-1]))&&(i.push(t),!0)},_saveAndTransform:function(t){var i=this.canvas.viewportTransform;t.save(),t.transform(i[0],i[1],i[2],i[3],i[4],i[5])},_reset:function(){this._lines={0:[]},this._lineIndex=0,this._setBrushStyles(),this._setShadow()},_render:function(){var t,i,e,s,r,n=this.canvas.contextTop;for(var a in this._saveAndTransform(n),this._lines){if(s=(e=this._lines[a])[0],r=e[1],n.beginPath(),2===e.length&&s.x===r.x&&s.y===r.y){var o=this.width/1e3;s=new fabric.Point(s.x,s.y),r=new fabric.Point(r.x,r.y),s.x-=o,r.x+=o}for(n.moveTo(s.x,s.y),t=1,i=e.length;t<i;t++)this._drawSegment(n,s,r),s=e[t],r=e[t+1];n.lineTo(s.x,s.y),n.stroke()}n.restore()},_finalizeAndAddPath:function(){this.canvas.contextTop.closePath();var t,i,e=[];for(var s in this._lines){if(e=this._lines[s],"M 0 0 Q 0 0 0 0 L 0 0"===(t=this.convertPointsToSVGPath(e).join("")))return void this.canvas.requestRenderAll();i=this.createPath(t),this.canvas.clearContext(this.canvas.contextTop),this.canvas.add(i),this.canvas.renderAll(),i.setCoords()}this._resetShadow(),this._reset(),this.canvas.fire("path:created",{path:i})}}),fabric.SelectionBrush=fabric.util.createClass(fabric.BaseBrush,{initialize:function(t){this.canvas=t,this._pointSets=[[]],this._currentPointSet=0,this._timeout=0,this._offset=0,this._mouseDragTimeout=null,this.strokeLineCap="butt",this.strokeLineJoin="miter",this.strokeDashArray=[5,5],this.currentMode="add"},replaceLastPoint:function(t){this._pointSets[this._currentPointSet][this._pointSets[this._currentPointSet].length-1]={mode:this.currentMode+"",point:new fabric.Point(Math.max(0,Math.min(this.canvas.subcanvas.width,t.x)),Math.max(0,Math.min(this.canvas.subcanvas.height,t.y)))}},addPoint:function(t,i){i&&0<this._pointSets[this._currentPointSet].length&&(this._currentPointSet=this._pointSets.push([])-1),this._pointSets[this._currentPointSet].push({mode:this.currentMode+"",point:new fabric.Point(Math.max(0,Math.min(this.canvas.subcanvas.width,t.x)),Math.max(0,Math.min(this.canvas.subcanvas.height,t.y)))})},onMouseDown:function(t){void 0!==t&&(this._setBrushStyles(),this._timeout=0,this._offset=0,this.addPoint(t,!0))},onMouseMove:function(t){void 0!==t&&(this._pointSets[this._currentPointSet].length<=1?(this.addPoint(t),this._render()):this.replaceLastPoint(t))},onMouseUp:function(t){},clear:function(){this._currentPointSet=[],this._pointsets=[],this._setBrushStyles(),this._setShadow()},_animate:function(t){this.canvas.clearContext(t),clearTimeout(this._timeout),this._saveAndTransform(t);var i=this.canvas.getZoom();for(var e in t.lineWidth=1/i,1<i&&t.setLineDash([this.strokeDashArray[0]/i,this.strokeDashArray[1]/i]),t.lineDashOffset=-this._offset++/i,this._pointSets)this._pointSets[e].length<=1||this.drawPath(t,this._pointSets[e]);for(var e in this._pointSets)this._pointSets[e].length<=1||this.clearInsidePath(t,this._pointSets[e]);var s=this;this._timeout=setTimeout(function(){fabric.util.requestAnimFrame(function(){30<s._offset&&(s._offset=0),s._animate(t)})},30),t.restore()},drawPath:function(t,i){for(var e in t.moveTo(this._pointSets[pointset][this._pointSets[pointset].length-1].x,this._pointSets[pointset][this._pointSets[pointset].length-1].y),this._pointsets[pointset])t.lineTo(this._pointSets[pointset][e].point.x,this._pointSets[pointset][e].point.y);t.stroke()},clearInsidePath:function(t,i){},_render:function(){var t=this.canvas.contextTop;this._animate(t)}}),fabric.RectSelectionBrush=fabric.util.createClass(fabric.SelectionBrush,{drawPath:function(t,i){var e=i[0].point.min(i[1].point),s=i[0].point.max(i[1].point),r=e.x,n=e.y,a=s.x-r,o=s.y-n;t.strokeRect(r,n,a,o)},clearInsidePath:function(t,i){var e=i[0].point.min(i[1].point),s=i[0].point.max(i[1].point),r=e.x+t.lineWidth/2,n=e.y+t.lineWidth/2,a=s.x-r-t.lineWidth/2,o=s.y-n-t.lineWidth/2;t.clearRect(r,n,a,o)}}),fabric.CanvasPlus=fabric.util.createClass(fabric.Canvas,{type:"CanvasPlus",initialize:function(t,i){var e=this,s={isDrawingMode:!0,interactive:!0,imageSmoothingEnabled:!1,enableRetinaScaling:!0,width:this.width,height:this.height,skipOffscreen:!1,subcanvas:{width:100,height:100,backgroundColor:"transparent",enableRotation:!0,angle:0},grid:{mode:"automatic",spacing:64,subdivisions:4,lines:{grid:{size:1.5,strokeStyle:"rgba(255, 255, 255, .25)"},subdivision:{size:1,strokeStyle:"rgba(255, 255, 255, .1)"}}},rulers:{defaults:{enabled:!0,position:zeroPoint(),width:i.width,height:30,rotate:0,backgroundColor:"rgba(0, 0, 0, .5)",alignment:"bottom",cursor:{enabled:!0,width:1,height:30,lineWidth:1,strokeStyle:"rgba(204, 204, 204, 1)",axis:"x",_pos:zeroPoint()},labels:{enabled:!0,useParentTransform:!0,rotation:0,rotateOrigin:zeroPoint(),translate:zeroPoint(),scale:onePoint(),color:"rgba(255, 255, 255, 1)",font:"10px Verdana",position:zeroPoint()},lines:{width:1,color:"rgba(255, 255, 255, 1)",sizes:{large:.6,medium:.8,small:.9}},unitDisplay:{enable:!0,position:new fabric.Point(0,0),width:"automatic",height:"automatic",backgroundColor:"rgba(0, 0, 0, .2)",font:"10px Verdana",fontColor:"white"},_vptIndice:4,_vptProp:"width",_vptZoomIndice:0,_canvas:null,_ctx:null},top:{position:new fabric.Point(30,0),labels:{position:new fabric.Point(0,14)}},left:{width:30,height:i.height,position:new fabric.Point(0,0),alignment:"right",cursor:{width:30,height:1,axis:"y"},labels:{rotate:-Math.PI/2,position:new fabric.Point(0,14)},_vptIndice:5,_vptProp:"height",_vptZoomIndice:3},bottom:{enabled:!1,position:new fabric.Point(0,i.height-30),width:i.width,alignment:"top",labels:{position:new fabric.Point(0,24)}},right:{enabled:!1,width:30,height:i.height,position:new fabric.Point(i.width-30,0),alignment:"left",cursor:{width:30,height:1,axis:"y"},labels:{rotate:Math.PI/2,position:new fabric.Point(0,-16)},_vptIndice:5,_vptProp:"height",_vptZoomIndice:3}},zoom:{max:2e6,min:.001,rate:100,mode:"progressive"},units:{type:"px",display:{enabled:!0,width:30,height:30,position:new fabric.Point(0,0),backgroundColor:"rgba(0, 0, 0, .5)",fontColor:"rgba(255, 255, 255, 1)",font:"10px Verdana"}}};i=_.assignIn({},s,i);var r=!propExists(i.rulers,"enabled")||isset(i.rulers,"enabled");if(r)for(var n in i.rulers)"defaults"!=n&&(i.rulers[n]=_.merge({},i.rulers.defaults,i.rulers[n]));if(isset(i.rulers.top,"enabled")&&(isset(i.rulers.left,"enabled")&&(i.rulers.left.position.y+=i.rulers.top.height+i.rulers.top.position.y,i.rulers.left.height-=i.rulers.top.height),isset(i.rulers.right,"enabled")&&(i.rulers.right.position.y+=i.rulers.top.height+i.rulers.top.position.y,i.rulers.right.height-=i.rulers.top.height)),isset(i.rulers.bottom,"enabled")&&(isset(i.rulers.left,"enabled")&&(i.rulers.left.height-=i.rulers.bottom.height),isset(i.rulers.right,"enabled")&&(i.rulers.right.height-=i.rulers.bottom.height)),r)for(var n in i.rulers)propExists(i.rulers[n],"enabled")&&!isset(i.rulers[n],"enabled")||(i.rulers[n]._canvas=document.createElement("canvas"),i.rulers[n]._canvas.width=i.rulers[n].width*fabric.devicePixelRatio,i.rulers[n]._canvas.height=i.rulers[n].height*fabric.devicePixelRatio,i.rulers[n]._canvas.style.width=i.rulers[n].width+"px",i.rulers[n]._canvas.style.height=i.rulers[n].height+"px",i.rulers[n]._ctx=i.rulers[n]._canvas.getContext("2d"),i.rulers[n]._ctx.scale(fabric.devicePixelRatio,fabric.devicePixelRatio));this.callSuper("initialize",t,i),this.subcanvas=new fabric.Rect(_.merge(this.subcanvas,{canvas:this})),this.subcanvas.setCoords(),this.panningBounds=this.calcViewportPanningBoundaries();var a=this.viewportTransform.slice(0);if(this.subcanvas.width>this.width||this.subcanvas.height>this.height){var o=0,h=0;if(r)for(n in this.rulers)"defaults"!=n&&propExists(this.rulers[n],"enabled")&&isset(this.rulers[n],"enabled")&&(4==this.rulers[n]._vptIndice&&(h+=this.rulers[n].height),5==this.rulers[n]._vptIndice&&(o+=this.rulers[n].width));var l=Math.min((this.width-o*fabric.devicePixelRatio)/this.subcanvas.width,(this.height-h*fabric.devicePixelRatio)/this.subcanvas.height);this.setZoom(l);var c=this.getVpCenter();(a=this.viewportTransform)[4]=(c.x+o)*l-this.subcanvas.width*l/2,a[5]=(c.y+h)*l-this.subcanvas.height*l/2}else a[4]=this.width/2-this.subcanvas.width/2,a[5]=this.height/2-this.subcanvas.height/2;this.setViewportTransform(a),this._internal={rulersNeedRecalc:!0},fabric.util.addListener(e.wrapperEl,"mousewheel",function(t){if(t.ctrlKey){var i=new fabric.Point(t.offsetX,t.offsetY);e.relativeZoomToPoint(i,t.deltaY)}else e.relativePan(new fabric.Point(-t.deltaX,-t.deltaY));e._internal.rulersNeedRecalc=!0}),fabric.util.addListener(e.wrapperEl,"mousemove",function(t){for(var i in e.rulers)"defaults"!=i&&isset(e.rulers[i].cursor,"enabled")&&("x"==e.rulers[i].cursor.axis?e.rulers[i].cursor._pos.x=t.offsetX:"y"==e.rulers[i].cursor.axis&&(e.rulers[i].cursor._pos.y=t.offsetY))}),this.freeDrawingBrush=fabric.RectSelectionBrush&&new fabric.RectSelectionBrush(this)},getZoom:function(){return this.viewportTransform[0]==this.viewportTransform[3]?this.viewportTransform[0]:Math.max(this.viewportTransform[0],this.viewportTransform[3])},relativeZoomToPoint:function(t,i){var e=this.panningBounds,s=this.getZoom(),r=s+-i*(s/this.zoom.rate);r<this.zoom.min?r=this.zoom.min:r>this.zoom.max&&(r=this.zoom.max);var n=t,a=this.viewportTransform.slice(0);transformedPoint=fabric.util.transformPoint(t,fabric.util.invertTransform(a)),a[0]=r,a[3]=r;var o=fabric.util.transformPoint(transformedPoint,a),h=this.subcanvas.width*r,l=a[4]+=n.x-o.x;l+h<=e.tl.x?a[4]=e.tl.x-h:l>=e.tr.x&&(a[4]=e.tr.x);var c=this.subcanvas.height*r,u=a[5]+=n.y-o.y;u+c<=e.tl.y?a[5]=e.tl.y-c:u>=e.bl.y&&(a[5]=e.bl.y),this.setViewportTransform(a)},relativePan:function(t){var i=this.viewportTransform.slice(0),e=i[4]+=t.x,s=i[5]+=t.y,r=this.panningBounds;e<r.tl.x-this.subcanvas.width*i[0]?e=r.tl.x-this.subcanvas.width*i[0]:e>r.tr.x&&(e=r.tr.x),s<r.tl.y-this.subcanvas.height*i[3]?s=r.tl.y-this.subcanvas.height*i[3]:s>r.br.y&&(s=r.br.y),i[4]=e,i[5]=s,this.setViewportTransform(i)},calcViewportPanningBoundaries:function(){var t={},i=this.width,e=this.height;new fabric.Point(this.subcanvas.width/2,this.subcanvas.height/2),fabric.util.degreesToRadians(this.subcanvas.angle);return t.tl=new fabric.Point(Math.floor(i/4),Math.floor(e/4)),t.br=new fabric.Point(Math.floor(i-i/4),Math.floor(e-e/4)),t.tr=new fabric.Point(t.br.x,t.tl.y),t.bl=new fabric.Point(t.tl.x,t.br.y),t},_beforeClip:function(t){var i=this.subcanvas.width/2,e=this.subcanvas.height/2,s=fabric.util.degreesToRadians(this.subcanvas.angle);t.translate(i,e),t.rotate(s),t.translate(-i,-e)},clipTo2:function(t){t.rect(0,0,this.subcanvas.width,this.subcanvas.height)},_afterClip:function(t){var i=this.subcanvas.width/2,e=this.subcanvas.height/2,s=fabric.util.degreesToRadians(this.subcanvas.angle);t.translate(i,e),t.rotate(-s),t.translate(-i,-e)},_renderBackground:function(t){t.save();var i=this.viewportTransform;t.transform(1,i[1],i[2],1,i[4],i[5]);var e=this.subcanvas.width*i[0]/2,s=this.subcanvas.height*i[3]/2;t.translate(e,s),t.rotate(fabric.util.degreesToRadians(this.subcanvas.angle)),t.translate(-e,-s),"transparent"==this.subcanvas.backgroundColor?(transparentBackgroundDataPattern||(transparentBackgroundDataPattern=t.createPattern(transparentBackgroundData,"repeat")),t.fillStyle=transparentBackgroundDataPattern):t.fillStyle=this.subcanvas.backgroundColor,t.fillRect(0,0,this.subcanvas.width*i[0],this.subcanvas.height*i[3]),t.restore()},_renderCursor:function(t,i){t.save(),t.lineWidth=i.cursor.lineWidth,t.strokeStyle=i.cursor.strokeStyle,t.beginPath(),"x"==i.cursor.axis?(t.moveTo(i.cursor._pos.x,i.position.y+i.height-i.cursor.height),t.lineTo(i.cursor._pos.x,i.position.y+i.cursor.height)):"y"==i.cursor.axis&&(t.moveTo(i.position.x+i.width-i.cursor.width,i.cursor._pos.y),t.lineTo(i.position.x+i.cursor.width,i.cursor._pos.y)),t.stroke(),t.restore()},_getRulerZoomIntervals:function(){var t=this.getZoom(),i=100,e=20,s=10,r=10;return t<.005?(i=5e4,e=1e4,r=s=5e3):.005<=t&&t<.01?(i=1e4,s=0,r=e=2e3,.008<=t&&(r=s=1e3)):.01<=t&&t<.032?(i=5e3,s=0,r=e=1e3,.016<=t&&(r=s=500)):.032<=t&&t<.05?(i=5e3,e=1e3,r=s=250):.05<=t&&t<.1?(i=1e3,s=0,r=e=200,.08<=t&&(r=s=100)):.1<=t&&t<.5?(i=500,s=0,r=e=100,.16<=t&&t<.32?r=s=50:.32<=t&&(r=s=25)):.5<=t&&t<.8?(s=0,r=20):1.6<=t&&t<3.2?r=s=5:3.2<=t&&t<5?r=s=2.5:5<=t&&t<8?(i=50,e=10,r=s=2.5,6.4<=t&&(r=s=1)):8<=t&&t<50?(i=10,s=0,r=e=1,16<=t&&t<32?r=s=.5:32<=t&&(r=s=.25)):50<=t&&(d=Math.floor(Math.log2(t/1e3))+2,i=r=1/Math.pow(2,d),e=s=0),{large:i,medium:e,small:s,step:r}},_getRulerMinAmount:function(t,i,e){return Math.ceil(-t/i/e)*e},_getRulerMaxAmount:function(t,i,e,s){return Math.ceil((i-t)/e/s)*s},_renderRuler:function(t,i){var e=this.viewportTransform,s=i._ctx,r=i.position.x,n=i.position.y,a=i.width,o=i.height;if(this._internal.rulersNeedRecalc){s.clearRect(0,0,a,o),s.save(),s.rect(0,0,a,o),s.clip(),s.fillStyle=i.backgroundColor,s.fill();var h,l,c=this._getRulerZoomIntervals(),u=c.large,d=c.medium,f=c.small,v=c.step,p=e[i._vptZoomIndice],g=this._getRulerMinAmount(e[i._vptIndice],p,v),b=this._getRulerMaxAmount(e[i._vptIndice],this[i._vptProp],p,v),m=(i.reverseDirection,0);for(s.beginPath(),h=g;h<=b;h+=v){if(0<u&&h%u==0)m=i.lines.sizes.large,!0;else if(0<d&&h%d==0)m=i.lines.sizes.medium;else{if(!(0<f&&h%f==0))continue;m=i.lines.sizes.small}l=h*p+e[i._vptIndice],"bottom"==i.alignment?(s.moveTo(l-r,i.height*m),s.lineTo(l-r,i.height)):"top"==i.alignment?(s.moveTo(l-r,0),s.lineTo(l-r,i.height-i.height*m)):"left"==i.alignment?(s.moveTo(0,l-n),s.lineTo(i.width-i.width*m,l-n)):"right"==i.alignment&&(s.moveTo(i.width*m,l-n),s.lineTo(i.width,l-n))}for(s.strokeStyle=i.lines.color,s.stroke(),i.labels.useParentTransform||(s.restore(),s.save()),s.fillStyle=i.labels.color,s.font=i.labels.font,i.labels.rotate&&(s.translate(i.labels.rotateOrigin.x,i.labels.rotateOrigin.y),s.rotate(i.labels.rotate)),h=g;h<=b;h+=v)if(h%u==0){l=h*p+e[i._vptIndice];var _=h.toString().split(".");text=h,void 0!==_[1]&&2<_[1].length&&(text=h.toFixed(2)),dims=t.measureText(text),"bottom"==i.alignment||"top"==i.alignment?s.fillText(text,l-r-dims.width/2+i.labels.position.x,i.labels.position.y):s.fillText(text,Math.sign(i.labels.rotate)*l-Math.sign(i.labels.rotate)*n-dims.width/2+i.labels.position.x,i.labels.position.y)}s.restore()}t.save(),t.drawImage(i._canvas,r,n,a,o),t.restore(),isset(i.cursor,"enabled")&&this._renderCursor(t,i)},_renderRulers:function(t){for(var i in this.rulers)"defaults"==i||!isset(this.rulers,i)||propExists(this.rulers[i],"enabled")&&!isset(this.rulers[i],"enabled")||this._renderRuler(t,this.rulers[i])},_renderUnitDisplay:function(t){var i=this.units.display.position.x,e=this.units.display.position.y,s=this.units.display.width,r=this.units.display.height;t.fillStyle=this.units.display.backgroundColor,t.fillRect(i,e,s,r),t.fillStyle=this.units.display.fontColor,t.font=this.units.display.font;var n=t.measureText(this.units.type);t.fillText(this.units.type,s/2-n.width/2,r/2+(n.actualBoundingBoxAscent+n.actualBoundingBoxDescent)/2)},_getAutoGridZoomIntervals:function(){var t=this.getZoom(),i=0,e=5;return t<.005?i=5e4:.005<=t&&t<.01?i=1e4:.01<=t&&t<.05?i=5e3:.05<=t&&t<.1?i=1e3:.1<=t&&t<.5?i=500:.5<=t&&t<5?i=100:5<=t&&t<8?i=50:8<=t&&t<50?e=i=10:(i=1,e=0),{spacing:i,subdivisions:e}},_renderGridSpacing:function(t,i,e,s){var r;t.beginPath(),t.strokeStyle=e,t.lineWidth=s;var n=this.subcanvas.width,a=this.subcanvas.height,o=i,h=this.subcanvas.width,l=this.viewportTransform,c=fabric.util.transformPoint(this.subcanvas.aCoords.tl,l),u=fabric.util.transformPoint(this.subcanvas.aCoords.br,l);for(c.x<0&&(o=Math.round(-c.x/l[0]/i)*i),u.x>this.width&&(h=Math.floor((this.subcanvas.width-(u.x-this.width)/l[0])/i)*i),r=o;r<=h;r+=i)t.moveTo(r*l[0],0),t.lineTo(r*l[0],a*l[3]);for(h=this.subcanvas.height-i,c.y<0&&(o=Math.round(-c.y/l[3]/i)*i),u.y>this.height&&(h=Math.floor((this.subcanvas.height-(u.y-this.height)/l[3])/i)*i),r=i;r<=a;r+=i)t.moveTo(0,r*l[3]),t.lineTo(n*l[0],r*l[3]);t.stroke()},_renderGrid:function(t){t.save();var i=this.viewportTransform;this.getZoom();t.transform(1,i[1],i[2],1,i[4],i[5]);var e,s,r=this.subcanvas.width*i[0]/2,n=this.subcanvas.height*i[3]/2;t.translate(r,n),t.rotate(fabric.util.degreesToRadians(this.subcanvas.angle)),t.translate(-r,-n);var a=this._getAutoGridZoomIntervals();"automatic"==this.grid.mode?(e=a.spacing,s=a.subdivisions):"manual"==this.grid.mode&&(e=this.grid.spacing,s=this.grid.subdivisions),min=a.subdivisions,this._renderGridSpacing(t,e,this.grid.lines.grid.strokeStyle,this.grid.lines.grid.size),e=Math.round(e/s),this._renderGridSpacing(t,e,this.grid.lines.subdivision.strokeStyle,this.grid.lines.subdivision.size),t.restore()},renderCanvas:function(t,i){var e=this.viewportTransform;this.isRendering&&(fabric.util.cancelAnimFrame(this.isRendering),this.isRendering=0),this.calcViewportBoundaries(),this.clearContext(t),this.fire("before:render"),this.freeDrawingBrush.color="black",t.save(),this._renderBackground(t,e),t.transform(e[0],e[1],e[2],e[3],e[4],e[5]),this.clipTo&&(this._beforeClip&&this._beforeClip(t),fabric.util.clipContext(this,t),this._afterClip&&this._afterClip(t)),this._renderObjects(t,i),t.restore(),this.clipTo&&t.restore(),isset(this.grid,"mode")&&this._renderGrid(t),t.restore(),!this.controlsAboveOverlay&&this.interactive&&this.drawControls(t),this._renderOverlay(t),this.controlsAboveOverlay&&this.interactive&&this.drawControls(t),this._renderRulers(t),this._internal.rulersNeedRecalc=!1,isset(this.units.display,"enabled")&&this._renderUnitDisplay(t),this.fire("after:render")}});